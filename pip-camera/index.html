<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Camera Selector with PiP</title>
<style>
    body {
        font-family: system-ui, sans-serif;
        background: #f7f7f8;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        height: 100vh;
        margin: 0;
        padding: 20px;
        color: #333;
    }

    h1 {
        margin-bottom: 10px;
    }

    select, button {
        font-size: 1rem;
        padding: 8px 12px;
        margin: 5px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background: white;
        cursor: pointer;
    }

    button:hover {
        background: #eee;
    }

    video {
        margin-top: 20px;
        width: 100%;
        max-width: 600px;
        border-radius: 10px;
        background: black;
    }

    #controls {
        margin-top: 10px;
    }
</style>
</head>
<body>
    <h1>Camera Selector with Picture-in-Picture</h1>
    <div id="controls">
        <select id="cameraSelect"></select>
        <button id="connectBtn">Connect</button>
        <button id="pipBtn" disabled>Picture-in-Picture</button>
    </div>
    <video id="video" autoplay playsinline></video>

<script>
const video = document.getElementById('video');
const cameraSelect = document.getElementById('cameraSelect');
const connectBtn = document.getElementById('connectBtn');
const pipBtn = document.getElementById('pipBtn');

let currentStream = null;
let connected = false;

// Get available video input devices
async function listCameras() {
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cameras = devices.filter(device => device.kind === 'videoinput');

        cameraSelect.innerHTML = '';
        cameras.forEach(camera => {
            const option = document.createElement('option');
            option.value = camera.deviceId;
            option.text = camera.label || `Camera ${cameraSelect.length + 1}`;
            cameraSelect.appendChild(option);
        });
    } catch (err) {
        console.error('Error listing cameras:', err);
        alert('Could not access camera list. Please allow permissions.');
    }
}

// Start camera stream
async function startCamera(deviceId) {
    if (currentStream) {
        stopCamera();
    }

    const constraints = {
        video: {
            deviceId: { exact: deviceId }
        }
    };

    try {
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = currentStream;
        pipBtn.disabled = false;
        connected = true;
        connectBtn.textContent = 'Disconnect';
    } catch (err) {
        console.error('Error accessing camera:', err);
        alert('Failed to start camera. Check permissions or device availability.');
    }
}

// Stop camera stream
function stopCamera() {
    if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
    }
    video.srcObject = null;
    pipBtn.disabled = true;
    connected = false;
    connectBtn.textContent = 'Connect';
}

// Handle connect/disconnect button
connectBtn.addEventListener('click', async () => {
    if (!connected) {
        const selectedId = cameraSelect.value;
        await startCamera(selectedId);
    } else {
        stopCamera();
    }
});

// Handle Picture-in-Picture
pipBtn.addEventListener('click', async () => {
    if (!document.pictureInPictureElement) {
        try {
            await video.requestPictureInPicture();
        } catch (err) {
            console.error('Picture-in-Picture error:', err);
            alert('PiP mode failed. Ensure this is triggered by a user action.');
        }
    } else {
        await document.exitPictureInPicture();
    }
});

// Initialize camera list on load
navigator.mediaDevices.getUserMedia({ video: true })
    .then(() => listCameras())
    .catch(err => {
        console.error('Permission denied or error:', err);
        alert('Please allow camera access to list available devices.');
    });

// Refresh camera list when devices change
navigator.mediaDevices.addEventListener('devicechange', listCameras);
</script>
</body>
</html>
